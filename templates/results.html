<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <title>Medical Report Analysis</title>
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css"
      rel="stylesheet"
    />
    <style>
      body {
        background: #f6f9fb;
      }
      .report-section {
        background: #fff;
        border-radius: 15px;
        box-shadow: 0 4px 16px rgba(66, 133, 244, 0.08);
        margin: 2rem auto;
        padding: 2.5rem;
        max-width: 800px;
      }
      .chatbot-container {
        position: fixed;
        bottom: 2rem;
        right: 2rem;
        width: 350px;
        max-width: 95vw;
        background: #fff;
        border-radius: 15px;
        box-shadow: 0 5px 15px rgba(0, 0, 0, 0.15);
        z-index: 1000;
      }
      .chat-header {
        background: #4285f4;
        color: #fff;
        padding: 12px 16px;
        border-top-left-radius: 15px;
        border-top-right-radius: 15px;
        font-weight: bold;
        font-size: 1.1rem;
      }
      .chat-messages {
        height: 260px;
        overflow-y: auto;
        padding: 1rem;
        background: #f9fafb;
      }
      .user-message {
        background: #e3f2fd;
        margin-left: auto;
        max-width: 80%;
        border-radius: 15px 15px 0 15px;
        padding: 8px 12px;
        margin-bottom: 4px;
      }
      .bot-message {
        background: #f8f9fa;
        max-width: 80%;
        border-radius: 15px 15px 15px 0;
        padding: 8px 12px;
        margin-bottom: 4px;
      }
      .chat-input {
        display: flex;
        border-top: 1px solid #eee;
        background: #fafbfc;
        padding: 8px;
      }
      .chat-input input {
        flex: 1;
        border: none;
        padding: 8px;
        font-size: 15px;
        border-radius: 8px 0 0 8px;
        outline: none;
        background: #fafbfc;
      }
      .chat-input button {
        background: #4285f4;
        color: #fff;
        border: none;
        padding: 0 18px;
        font-size: 15px;
        border-radius: 0 8px 8px 0;
        cursor: pointer;
      }
      .chat-input button:active {
        background: #1967d2;
      }
      @media (max-width: 600px) {
        .report-section {
          padding: 1rem;
        }
        .chatbot-container {
          right: 0.5rem;
          bottom: 0.5rem;
          width: 98vw;
        }
      }
      /* Markdown-style headers */
      .report-section h2,
      .report-section h3,
      .report-section h4 {
        color: #4285f4;
        margin-top: 1.2em;
      }
      .report-section ul,
      .report-section ol {
        margin-left: 1.5em;
      }
      .report-section strong {
        color: #c0392b;
      }
      .report-section em {
        color: #2980b9;
      }
    </style>
  </head>
  <body>
    <div class="container">
      <div class="report-section">
        <h2 class="mb-4 text-primary">
          ðŸ“‹ Medical Report Summary
          <small class="text-muted d-block mt-2"
            >Generated by AI Health Assistant</small
          >
        </h2>
        <div id="analysis" class="markdown-body">{{ analysis|safe }}</div>
      </div>
    </div>

    <!-- Chatbot -->
    <div class="chatbot-container" id="chatContainer">
      <div class="chat-header">ðŸ©º Report Assistant</div>
      <div class="chat-messages" id="chatMessages">
        <div class="bot-message">
          I can answer questions about your medical report or health results.
          Please ask about your test results, findings, or medical terms.
        </div>
      </div>
      <div class="chat-input">
        <input
          type="text"
          id="userInput"
          placeholder="Ask about your report or results..."
        />
        <button onclick="sendQuestion()">Send</button>
      </div>
    </div>
    <script>
      async function sendQuestion() {
        const input = document.getElementById("userInput");
        const messages = document.getElementById("chatMessages");
        const question = input.value.trim();
        if (!question) return;
        messages.innerHTML += `<div class="user-message">${question}</div>`;
        input.value = "";
        messages.scrollTop = messages.scrollHeight;

        try {
          const response = await fetch("/ask", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ question }),
          });
          const data = await response.json();
          messages.innerHTML += `<div class="bot-message">${data.response}</div>`;
          messages.scrollTop = messages.scrollHeight;
        } catch (error) {
          messages.innerHTML += `<div class="bot-message text-danger">Error: Could not get response</div>`;
        }
      }
      // Optional: Press Enter to send
      document
        .getElementById("userInput")
        .addEventListener("keypress", function (e) {
          if (e.key === "Enter") sendQuestion();
        });
    </script>
  </body>
</html>
